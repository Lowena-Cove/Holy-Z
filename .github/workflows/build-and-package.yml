name: Build and Package Holy Z

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build:
    name: Build Holy Z
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            executable: HolyZ
            package_name: HolyZ-Linux
          - os: windows-latest
            platform: windows
            executable: HolyZ.exe
            package_name: HolyZ-Windows

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-ttf-dev \
          libboost-system-dev \
          libboost-filesystem-dev

    - name: Setup vcpkg (Windows)
      if: matrix.platform == 'windows'
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '3426db05b996481ca31e95fff3734cf23e0f51bc'

    - name: Install dependencies (Windows)
      if: matrix.platform == 'windows'
      shell: pwsh
      run: |
        # Retry vcpkg install up to 3 times to handle network issues
        $maxRetries = 3
        $retryCount = 0
        do {
          $retryCount++
          Write-Host "Attempt $retryCount of $maxRetries"
          try {
            vcpkg install --triplet x64-windows --debug
            break
          } catch {
            if ($retryCount -eq $maxRetries) { throw }
            Write-Host "Retry in 30 seconds..."
            Start-Sleep -Seconds 30
          }
        } while ($retryCount -lt $maxRetries)

    - name: Configure CMake (Linux)
      if: matrix.platform == 'linux'
      working-directory: HolyZ
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release

    - name: Configure CMake (Windows)
      if: matrix.platform == 'windows'
      working-directory: HolyZ
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="${env:VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=x64-windows

    - name: Build project
      working-directory: HolyZ/build
      run: cmake --build . --config Release

    - name: Create package directory
      run: mkdir package

    - name: Package files (Linux)
      if: matrix.platform == 'linux'
      run: |
        cp ZSharp/build/${{ matrix.executable }} package/
        cp HolyZ/build/${{ matrix.executable }} package/
        cp README.md package/
        cp LICENSE package/
        
    - name: Package files (Windows)
      if: matrix.platform == 'windows'
      shell: pwsh
      run: |
        Copy-Item "ZSharp/build/Release/${{ matrix.executable }}" "package/"
        Copy-Item "HolyZ/build/Release/${{ matrix.executable }}" "package/"
        Copy-Item "README.md" "package/"
        Copy-Item "LICENSE" "package/"
        
        # Copy required DLLs from vcpkg
        $vcpkgBin = "$env:VCPKG_ROOT/installed/x64-windows/bin"
        if (Test-Path $vcpkgBin) {
          Copy-Item "$vcpkgBin/SDL2.dll" "package/" -ErrorAction SilentlyContinue
          Copy-Item "$vcpkgBin/SDL2_image.dll" "package/" -ErrorAction SilentlyContinue
          Copy-Item "$vcpkgBin/SDL2_ttf.dll" "package/" -ErrorAction SilentlyContinue
          Copy-Item "$vcpkgBin/*.dll" "package/" -ErrorAction SilentlyContinue
        }

    - name: Create archive (Linux)
      if: matrix.platform == 'linux'
      run: |
        cd package
        tar -czf ../${{ matrix.package_name }}.tar.gz *

    - name: Create archive (Windows)
      if: matrix.platform == 'windows'
      shell: pwsh
      run: |
        Compress-Archive -Path "package/*" -DestinationPath "${{ matrix.package_name }}.zip"

    - name: Upload build artifact (Linux)
      if: matrix.platform == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.package_name }}
        path: ${{ matrix.package_name }}.tar.gz
        retention-days: 30

    - name: Upload build artifact (Windows)
      if: matrix.platform == 'windows'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.package_name }}
        path: ${{ matrix.package_name }}.zip
        retention-days: 30

    - name: Upload to release (Linux)
      if: github.event_name == 'release' && matrix.platform == 'linux'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ${{ matrix.package_name }}.tar.gz
        asset_name: ${{ matrix.package_name }}.tar.gz
        asset_content_type: application/gzip

    - name: Upload to release (Windows)
      if: github.event_name == 'release' && matrix.platform == 'windows'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ${{ matrix.package_name }}.zip
        asset_name: ${{ matrix.package_name }}.zip
        asset_content_type: application/zip
